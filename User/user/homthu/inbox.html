<?php
// Luôn bắt đầu session ở dòng đầu tiên
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}
?>
<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hòm thư - Dynamic Fitness Club</title>
  <meta name="description" content="Xem thông báo và tin nhắn từ DFC Gym">
  <link rel="icon" type="image/png" href="../../assets/img/logo.png">
  <link rel="shortcut icon" type="image/png" href="../../assets/img/logo.png">
  <link rel="apple-touch-icon" href="../../assets/img/logo.png">
  <link rel="stylesheet" href="../../assets/css/style.css">
  <link rel="stylesheet" href="../../assets/css/support.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>

<body data-logged-in="<?php echo isset($_SESSION['user']) ? 'true' : 'false'; ?>">

  <div class="menu-overlay" id="menu-overlay"></div>
  <div class="page-wrapper" id="page-wrapper">

    <header class="header">
      <div class="container nav">
        <a class="brand" href="../../index.html">
          <img src="../../assets/img/logo.png" alt="DFC Gym" class="logo">
          <span>DFC GYM</span>
        </a>
        <nav class="menu desktop-nav">
          <?php if (isset($_SESSION['user'])): ?>
            <a href="../../index.html" class="nav-link">Trang chủ</a>
            <a href="goitap/packages.html" class="nav-link">Gói tập</a>
            <a href="khuyenmai/promotions.php" class="nav-link">Khuyến mãi</a>
            <a href="schedule.html" class="nav-link">Lịch tập</a>
            <a href="support.html" class="nav-link">Hỗ trợ</a>
            <a href="review.html" class="nav-link">Đánh giá</a>
          <?php else: ?>
            <a href="../../index.html#gioi-thieu" class="nav-link">Giới thiệu</a>
            <a href="../../index.html#dich-vu" class="nav-link">Dịch vụ</a>
            <a href="../../index.html#thiet-bi" class="nav-link">Thiết bị</a>
            <a href="../../index.html#hlv" class="nav-link">HLV</a>
            <a href="#dang-nhap" class="btn" data-modal-target="login-modal">Đăng nhập</a>
          <?php endif; ?>
        </nav>
        <?php if (isset($_SESSION['user'])): ?>
        <div class="menu-actions">
          <span style="color: var(--text); font-weight: 600; margin-right: 12px; white-space: nowrap;">
            Chào, <?php echo htmlspecialchars($_SESSION['user']['full_name'] ?? $_SESSION['user']['username']); ?>!
          </span>
          <?php if ($_SESSION['user']['role'] === 'admin'): ?>
            <a href="../admin/index.html" class="btn ghost">Vào Admin</a>
          <?php endif; ?>
          <div class="user-menu-wrapper">
              <button class="user-icon-button" id="user-menu-button">
                  <i class="fas fa-user-circle"></i>
              </button>
              <div class="user-dropdown" id="user-dropdown-menu">
                  <a href="#profile" data-modal-target="account-modal"><i class="fas fa-user-edit"></i> Thông tin tài khoản</a>
                  <a href="inbox.html"><i class="fas fa-inbox"></i> Hòm thư</a>
                  <a href="#my-packages" data-modal-target="account-modal"><i class="fas fa-box"></i> Gói tập của bạn</a>
                  <a href="#payment-history" data-modal-target="account-modal"><i class="fas fa-history"></i> Lịch sử thanh toán</a>
                  <a href="#payment-management" data-modal-target="account-modal"><i class="fas fa-credit-card"></i> Quản lý thanh toán</a>
                  <a href="#change-password" data-modal-target="account-modal"><i class="fas fa-key"></i> Đổi mật khẩu</a>
                  <a href="logout.php" class="logout-link"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a>
              </div>
          </div>
        </div>
        <?php endif; ?>
        <button class="menu-toggle" aria-label="Mở menu" aria-expanded="false" aria-controls="main-menu">
          <span class="bar"></span> <span class="bar"></span> <span class="bar"></span>
        </button>
      </div>
    </header>

    <nav class="menu-panel" id="main-menu">
      <div class="menu-header">
        <a class="menu-brand" href="../../index.html">
          <img src="../../assets/img/logo.png" alt="DFC Gym" class="menu-logo">
          <span>DFC GYM</span>
        </a>
      </div>
       <?php if (isset($_SESSION['user'])): ?>
        <span class="menu-user-name">
          <?php echo htmlspecialchars($_SESSION['user']['full_name'] ?? $_SESSION['user']['username']); ?>
        </span>
        <a href="../../index.html">Trang chủ</a>
        <a href="goitap/packages.html">Gói tập</a>
        <a href="khuyenmai/promotions.php">Khuyến mãi</a>
        <a href="schedule.html">Lịch tập</a>
        <a href="support.html">Hỗ trợ</a>
        <a href="review.html">Đánh giá</a>
        <?php if ($_SESSION['user']['role'] === 'admin'): ?>
          <a href="../admin/index.html">Vào Admin</a>
        <?php endif; ?>
        <div class="user-menu-wrapper">
             <a href="#profile" data-modal-target="account-modal"><i class="fas fa-user-edit"></i> Thông tin tài khoản</a>
             <a href="inbox.html"><i class="fas fa-inbox"></i> Hòm thư</a>
             <a href="#my-packages" data-modal-target="account-modal"><i class="fas fa-box"></i> Gói tập của bạn</a>
             <a href="#payment-history" data-modal-target="account-modal"><i class="fas fa-history"></i> Lịch sử thanh toán</a>
             <a href="#payment-management" data-modal-target="account-modal"><i class="fas fa-credit-card"></i> Quản lý thanh toán</a>
             <a href="#change-password" data-modal-target="account-modal"><i class="fas fa-key"></i> Đổi mật khẩu</a>
             <a href="logout.php" class="logout-link"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a>
        </div>
      <?php else: ?>
        <a href="../../index.html#gioi-thieu">Giới thiệu</a>
        <a href="../../index.html#dich-vu">Dịch vụ</a>
        <a href="../../index.html#thiet-bi">Thiết bị</a>
        <a href="../../index.html#hlv">HLV</a>
        <a href="#dang-nhap" class="btn" id="login-button-mobile" data-modal-target="login-modal">Đăng nhập</a>
      <?php endif; ?>
    </nav>

    <main class="main-content-area">
        <section class="section">
          <div class="inbox-container">
            <h1 class="section-title center">
              <i class="fas fa-inbox"></i> Hòm thư
            </h1>
            <p class="muted center" style="max-width: 600px; margin-left: auto; margin-right: auto; margin-bottom: 40px;">
                Xem thông báo, phản hồi hỗ trợ và cập nhật từ DFC Gym
            </p>

            <div class="inbox-stats">
              <div class="stat-card">
                <div class="stat-number" id="total-count">0</div>
                <div class="stat-label">Tổng số thông báo</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="unread-count" style="color: var(--accent);">0</div>
                <div class="stat-label">Chưa đọc</div>
              </div>
            </div>

            <div id="notifications-list">
              <div style="text-align: center; padding: 40px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: var(--primary);"></i>
                <p style="margin-top: 15px; color: var(--muted);">Đang tải thông báo...</p>
              </div>
            </div>
          </div>
        </section>
    </main>

    <?php include __DIR__ . '/../includes/footer.php'; ?>

  </div>
  
  <script src="../../assets/js/auth.js?v=6"></script>
  
  <!-- Navigation Script - Phải load trước các script khác -->
  <script src="../../assets/js/navigation.js?v=3"></script>
  
  <script src="../../assets/js/user-menu.js?v=3"></script>
  
  <script>
    // Load thông báo khi trang được tải
    document.addEventListener('DOMContentLoaded', function() {
      loadNotifications();
    });

    async function loadNotifications() {
      try {
        const response = await fetch('get_inbox.php');
        const data = await response.json();
        
        if (data.success) {
          displayNotifications(data.notifications);
          document.getElementById('total-count').textContent = data.notifications.length;
          document.getElementById('unread-count').textContent = data.unread_count;
        } else {
          document.getElementById('notifications-list').innerHTML = 
            '<div class="empty-inbox"><i class="fas fa-inbox"></i><p>' + (data.message || 'Không thể tải thông báo') + '</p></div>';
        }
      } catch (error) {
        console.error('Error loading notifications:', error);
        document.getElementById('notifications-list').innerHTML = 
          '<div class="empty-inbox"><i class="fas fa-exclamation-triangle"></i><p>Có lỗi xảy ra khi tải thông báo</p></div>';
      }
    }

    function displayNotifications(notifications) {
      const container = document.getElementById('notifications-list');
      
      if (!notifications || notifications.length === 0) {
        container.innerHTML = `
          <div class="empty-inbox">
            <i class="fas fa-inbox"></i>
            <p>Bạn chưa có thông báo nào</p>
          </div>
        `;
        return;
      }
      
      let html = '';
      notifications.forEach(notif => {
        const isUnread = notif.da_doc == 0;
        const typeClass = notif.loai_thong_bao.toLowerCase().replace(' ', '-');
        const badgeClass = {
          'Hệ thống': 'badge-system',
          'Khuyến mãi': 'badge-promo',
          'Sự kiện': 'badge-event',
          'Nhắc nhở': 'badge-reminder'
        }[notif.loai_thong_bao] || 'badge-system';
        
        const date = new Date(notif.ngay_gui);
        const dateStr = date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        
        html += `
          <div class="notification-item ${isUnread ? 'unread' : ''}" onclick="markAsRead(${notif.thong_bao_id})">
            <div class="notification-header">
              <div style="flex: 1;">
                <span class="notification-title">${escapeHtml(notif.tieu_de)}</span>
                <span class="notification-badge ${badgeClass}">${notif.loai_thong_bao}</span>
                ${isUnread ? '<span class="notification-badge" style="background: var(--accent); color: white; margin-left: 5px;">Mới</span>' : ''}
              </div>
              <div class="notification-date">${dateStr}</div>
            </div>
            <div class="notification-content">${escapeHtml(notif.noi_dung)}</div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    async function markAsRead(id) {
      try {
        const formData = new FormData();
        formData.append('thong_bao_id', id);
        
        await fetch('mark_read.php', {
          method: 'POST',
          body: formData
        });
        
        // Reload thông báo
        loadNotifications();
      } catch (error) {
        console.error('Error marking as read:', error);
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>

</body>
</html>

